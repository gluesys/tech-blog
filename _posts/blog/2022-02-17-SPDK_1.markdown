---
layout:     post
title:      "SPDK ì‹œë¦¬ì¦ˆ 1 : SPDK ì‹¤ìŠµ ì–´ë””ê¹Œì§€ í•´ë´¤ë‹ˆ?"
date:       2022-04-19
author:     ê¹€ íƒœí›ˆ (thkim@gluesys.com)
categories: blog
tags:       [SPDK, NVMe, SSD, Flash, Memory, RDMA, Storage]
cover:      "/assets/SPDK_maincover.jpg"
main:       "/assets/SPDK_maincover.jpg"
---

ì¸ì‚¬ë§
---

ìµœê·¼ ìŠ¤í† ë¦¬ì§€ ì—°êµ¬ë¥¼ ìˆ˜í–‰í•˜ë©´ì„œ SPDKë¥¼ ë‹¤ë£° ì¼ì´ ë§ì•„ì¡ŒëŠ”ë°, ê´€ë ¨ ìë£Œë¥¼ ì°¾ë‹¤ ë³´ë‹ˆ ìµœì‹  ê¸°ìˆ ì´ì–´ì„œ ê·¸ëŸ°ì§€ ì‹¤ìŠµ ì •ë³´ê°€ ë§ì´ ë¶€ì¡±í•˜ë‹¤ëŠ” ê²ƒì„ ëŠê¼ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ê·¸ë™ì•ˆ ê²½í—˜í–ˆë˜ ë‚´ìš©ì„ ì˜ ì •ë¦¬í•´ì„œ ì „ë‹¬í•´ ë³´ê³ ì í•©ë‹ˆë‹¤. SPDK ê°œë°œì— ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” NVMe SSDì™€ SPDKì˜ ìµœì‹  ì½”ë“œë¥¼ ì´ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ êµ¬ì¶•í•´ ë³´ê³  SPDKì—ì„œ ì œê³µí•˜ëŠ” ìŠ¤í† ë¦¬ì§€ ê¸°ëŠ¥ì„ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.

ì‹œì‘ì— ì•ì„œ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì˜ ë¸”ë¡ ê³„ì¸µ ë° NVMe SSD, SPDKì— ëŒ€í•œ ì§€ì‹ê³¼ git, ì»´íŒŒì¼ ê²½í—˜ì´ ìˆëŠ” ë¶„ë“¤ì€ ë³¸ í¬ìŠ¤íŠ¸ë¥¼ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ë³¸ê²©ì ìœ¼ë¡œ ì‹œì‘í•´ ë³´ê² ìŠµë‹ˆë‹¤!

ì§€ë‚œ [í¬ìŠ¤íŒ…](https://tech.gluesys.com/blog/2022/02/18/SPDK_1.html)ì—ì„œ ì†Œê°œí•œ ë°”ì™€ ê°™ì´ SPDK(Storage Performance Development Kit)ëŠ” ì‚¬ìš©ì ê³µê°„(userspace) ê³„ì¸µì—ì„œ NVMe(Non-Volatile Memory Express)ì™€ ê°™ì€ ì´ˆê³ ì† SSD ì¥ì¹˜ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.

![Alt text](/assets/SPDK_architecture.jpg) 
<center>ê·¸ë¦¼ 1. SPDK Architecture</center> (â€»ì°¸ê³  : [Presentation of 2018 Storage Developer Conference](https://www.snia.org/sites/default/files/SDC/2018/presentations/SSS_NVM_PM_NVDIMM/Luse_P_Trahe_F_Virtual_BDEVs_The_Secret_to_Customizing_SPDK.pdf))

&nbsp;

SPDKëŠ” í¬ê²Œ ìŠ¤í† ë¦¬ì§€ ì „ìš©ì˜ ì¸í„°í˜ì´ìŠ¤(Storage Protocol)ì™€ SPDKì˜ í•µì‹¬ ê°œë…ì´ ì •ì˜ëœ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Driver), ê·¸ë¦¬ê³  ì»¤ë„ì—ì„œ ì œê³µí•˜ë˜ ë¸”ë¡ ì¥ì¹˜ ê¸°ìˆ (Storage Service)ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. SPDKì—ì„œëŠ” ë¸”ë¡ ì¥ì¹˜ ê¸°ìˆ ì„ 'Block Device Drvier' ë˜ëŠ” 'Block Device Module', ì¤„ì—¬ì„œ 'bdev'ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.

bdevëŠ” ê¸°ì¡´ ì»¤ë„ì—ì„œ ì¥ì¹˜ ë“œë¼ì´ë²„ë³´ë‹¤ ìƒìœ„ ê³„ì¸µì—ì„œ ë™ì‘í•˜ëŠ” ë¸”ë¡ ê³„ì¸µì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ë“¤ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” C ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. ë¸”ë¡ ê³„ì¸µì€ ìŠ¤í† ë¦¬ì§€ì˜ ê¸°ë³¸ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ëŠ”ë°, ëŒ€í‘œì ì¸ ê¸°ëŠ¥ìœ¼ë¡œ ë…¼ë¦¬ ë³¼ë¥¨ê³¼ ì†Œí”„íŠ¸ì›¨ì–´ RAID, ì••ì¶•/ì¤‘ë³µ ì œê±° ë“±ì´ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ SPDKì— êµ¬í˜„ëœ bdev ëª©ë¡ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
  * Ceph RBD(RADOS Block Device)
  * Thin Provisioning
  * Device Crypto
  * Throughput Delay
  * GPT(for GUID partition table) & Partitioning
  * iSCSI Initiator (binding LUN to bdev)
  * Open CAS Framework(OCF)
  * Malloc(ramdisk)
  * Null(Similar to '/dev/null')
  * NVMe Device
  * Logical Volume
  * Passthrough
  * Pmem
  * S/W RAID
  * Split
  * Uring
  * Virtio-Block & Virtio-SCSI using vhost

ìµìˆ™í•œ ê¸°ëŠ¥ê³¼ ì²˜ìŒ ë³´ëŠ” ê¸°ëŠ¥ë„ ë³´ì´ë„¤ìš”. ëª¨ë“ˆì˜ ìì„¸í•œ ì„¤ëª…ì€ [ë§í¬](https://spdk.io/doc/bdev.html)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì™¸ì—ë„ ê°œë°œìëŠ” SPDKì—ì„œ ì œê³µí•˜ëŠ” bdev ë¼ì´ë¸ŒëŸ¬ë¦¬([bdev.h](https://spdk.io/doc/bdev_8h.html))ë¥¼ ì´ìš©í•˜ì—¬ ìŠ¤í† ë¦¬ì§€ ê¸°ëŠ¥ì„ ìœ ì € ë ˆë²¨ì—ì„œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

&nbsp;

# SPDK í™˜ê²½ êµ¬ì¶•

ì´ì œë¶€í„° ì´ë²ˆ í¬ìŠ¤íŒ…ì˜ ëª©í‘œì¸ SPDK  ì‹¤ìŠµ í™˜ê²½ì„ êµ¬ì„±í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ë¨¼ì € SPDK ê¹ƒí—ˆë¸Œì—ì„œ master ë¸Œëœì¹˜ì˜ ìµœì‹  ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸ ì¥ë¹„ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. 

  ```
  [root@localhost ~]# git clone https://github.com/spdk/spdk
  [root@localhost ~]# cd spdk
  ```

ê·¸ë¦¬ê³  ì„¤ì¹˜í•  ì½”ë“œì˜ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/pkgdep.sh --all
  ```

íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ ë¹Œë“œë¥¼ í•´ì¤ë‹ˆë‹¤. ì´ë•Œ ì»´íŒŒì¼ ì „ì— `./configure` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ”ë°, ì–´ë–¤ ê¸°ëŠ¥ë“¤ì„ í™œì„± í• ì§€ ì˜µì…˜ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ì¼ë‹¨ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# ./configure
  [root@localhost spdk]# make -j 40
  ```

ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ ì‹œìŠ¤í…œì˜ NVMe SSDë¥¼ SPDK ë“œë¼ì´ë²„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‹œìŠ¤í…œê³¼ NVMe SSDì˜ ì—°ê²° í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤. ì»¤ë„ì€ ìš´ì˜ì²´ì œê°€ ë¶€íŒ…ë˜ë©´ì„œ ì»´í“¨í„°ì— ì—°ê²°ëœ ì¥ì¹˜ë“¤ì„ ì¸ì‹í•˜ê³  ê´€ë ¨ëœ ë“œë¼ì´ë²„ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¥ì¹˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì»¤ë„ ë“œë¼ì´ë²„ì—ì„œ ì¥ì¹˜ì— ëŒ€í•œ ì˜¤ë„ˆì‰½ì„ í•´ì œí•´ì•¼ SPDKì—ì„œ ì¥ì¹˜ì˜ ì˜¤ë„ˆì‰½ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í˜„ì¬ í…ŒìŠ¤íŠ¸ ì¥ë¹„ì—ëŠ” Intel Optane NVMe SSDê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì¥ì¹˜ë¥¼ SPDKì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì»¤ë„ê³¼ì˜ ì¥ì¹˜ í•´ì œëŠ” `scripts/setup.sh` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# nvme list
  Node             SN                   Model                                    Namespace Usage                      Format           FW Rev
  ---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------
  /dev/nvme0n1     PHMB7435004J280CGN   INTEL SSDPED1D280GA                      1         280.07  GB / 280.07  GB    512   B +  0 B   E2010325
  [root@localhost spdk]# lsblk | grep nvme
  nvme0n1 259:0    0 260.9G  0 disk
  [root@localhost spdk]# scripts/setup.sh
  0000:80:04.2 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.3 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.0 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.1 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.6 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.7 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.4 (8086 2021): Already using the uio_pci_generic driver
  0000:80:04.5 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.2 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.3 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.0 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.1 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.6 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.7 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.4 (8086 2021): Already using the uio_pci_generic driver
  0000:00:04.5 (8086 2021): Already using the uio_pci_generic driver
  0000:3b:00.0 (8086 2700): nvme -> uio_pci_generic
  ```

PCIe 0000:3b:00.0 ì¥ì¹˜ì— ëŒ€í•œ ì»¤ë„ ë“œë¼ì´ë²„ í•´ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¡°íšŒí•´ ë³¼ê¹Œìš”?

  ```
  [root@localhost spdk]# nvme list
  [root@localhost spdk]# lsblk | grep nvme
  ```

ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë ¨ëœ ì»¤ë„ ë“œë¼ì´ë²„ì—ì„œ ì¥ì¹˜ì˜ ì˜¤ë„ˆì‰½ì„ í•´ì œí–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

SPDKëŠ” ì¥ì¹˜ì˜ ì˜¤ë„ˆì‰½ì„ ì‚¬ìš©ì ê³µê°„ì˜ í”„ë¡œê·¸ë¨ì— í• ë‹¹í•˜ê¸° ìœ„í•´ VFIO[^1] ë˜ëŠ” UIO[^2] ê¸°ìˆ ì„ ì´ìš©í•©ë‹ˆë‹¤. ë‘ ê¸°ìˆ ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ ë³¸ í¬ìŠ¤íŒ…ì˜ ëª©ì ê³¼ ë‹¤ë¥´ë‹ˆ ì´ ë¶€ë¶„ì€ í–¥í›„ ì‹¬í™” ê³¼ì •ìœ¼ë¡œ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ë‚´ìš©ì€ [ë§í¬](https://spdk.io/doc/concepts.html)ë¥¼ ì°¸ê³ í•˜ì‹œë©´ ë˜ê² ìŠµë‹ˆë‹¤.

SPDKì—ì„œ ì‚¬ìš©í•œ ì¥ì¹˜ì˜ ì˜¤ë„ˆì‰½ì„ ë‹¤ì‹œ ì»¤ë„ì— ë„˜ê¸°ë ¤ë©´ `reset` ì˜µì…˜ì„ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/setup.sh reset
  0000:3b:00.0 (8086 2700): uio_pci_generic -> nvme
  0000:80:04.2 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.3 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.0 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.1 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.6 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.7 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.4 (8086 2021): uio_pci_generic -> no driver
  0000:80:04.5 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.2 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.3 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.0 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.1 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.6 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.7 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.4 (8086 2021): uio_pci_generic -> no driver
  0000:00:04.5 (8086 2021): uio_pci_generic -> no driver
  [root@localhost spdk]# lsblk | grep nvme
  nvme0n1 259:0    0 260.9G  0 disk
  ```

ì´ì–´ì„œ SPDK í™˜ê²½ì´ ì •ìƒì ìœ¼ë¡œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë‹¤ì‹œ `scripts/setup.sh` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ì¥ì¹˜ë¥¼ ì¤€ë¹„í•˜ê³ , `build/exmpales/hello_world` ì˜ˆì œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# build/examples/hello_world
  [2022-01-13 03:44:04.916653] Starting SPDK v22.01-pre git sha1 ed8be4ad0 / DPDK 21.08.0 initialization...
  [2022-01-13 03:44:04.916839] [ DPDK EAL parameters: [2022-01-13 03:44:04.916872] hello_world [2022-01-13 03:44:04.916896] -c 0x1 [2022-01-13 03:44:04.916919] --log-level=lib.eal:6 [2022-01-13 03:44:04.916942] --log-level=lib.cryptodev:5 [2022-01-13 03:44:04.916986] --log-level=user1:6 [2022-01-13 03:44:04.917014] --iova-mode=pa [2022-01-13 03:44:04.917040] --base-virtaddr=0x200000000000 [2022-01-13 03:44:04.917062] --match-allocations [2022-01-13 03:44:04.917086] --file-prefix=spdk0 [2022-01-13 03:44:04.917111] --proc-type=auto [2022-01-13 03:44:04.917133] ]
  EAL: No available 1048576 kB hugepages reported
  EAL: No free 2048 kB hugepages reported on node 1
  TELEMETRY: No legacy callbacks, legacy socket not created
  Initializing NVMe Controllers
  Attaching to 0000:3b:00.0
  Attached to 0000:3b:00.0
  Using controller INTEL SSDPED1D280GA  (PHMB7435004J280CGN  ) with 1 namespaces.
    Namespace ID: 1 size: 280GB
    Initialization complete.
    INFO: using host memory buffer for IO
    Hello world!
  ```

'Hello World!'  ê°œë°œìë¼ë©´ ìµìˆ™í•œ ë¬¸ì¥ì´ ë³´ì…ë‹ˆë‹¤. ì˜ˆì œì—ì„œëŠ” ì»¤ë„ì˜ ë“œë¼ì´ë²„ì™€ ì—°ê²° í•´ì œí•œ NVMe ì¥ì¹˜ë¥¼ SPDKì—ì„œ ì§ì ‘ í†µì‹ í•˜ì—¬ SSDì˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì˜ˆì œì˜ ì½”ë“œëŠ” `examples/nvme/hello_world/hello_world.c`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  * ì°¸ê³ 
    - https://spdk.io/doc/getting_started.html
    - https://spdk.io/doc/concepts.html
    - https://spdk.io/doc/bdev.html

&nbsp;

# SPDK ì‹¤ìŠµ

SPDKëŠ” bdevì™€ ê°™ì€ ê¸°ëŠ¥ì„ ë™ì ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ JSON-RPC[^3] í”„ë¡œí† ì½œì„ ì´ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ ê°„ì˜ í†µì‹ ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ëŠ” ì»¤ë„ì—ì„œ ì‹œìŠ¤í…œ ì½œì„ í†µí•´ ì¥ì¹˜ ë“œë¼ì´ë²„ì— ì‚¬ìš©ì ëª…ë ¹ì„ ì „ë‹¬í•˜ëŠ” ê²ƒê³¼ ê°™ì€ êµ¬ì¡°ì…ë‹ˆë‹¤.

`app` ë””ë ‰í† ë¦¬ì—ëŠ” SPDKì—ì„œ ì œê³µí•˜ëŠ” ëª¨ë“  êµ¬ì„± ìš”ì†Œë“¤ì„ ì‚¬ìš©í•´ ë³´ê³  í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì •ìƒì ìœ¼ë¡œ ë¹Œë“œê°€ ì™„ë£Œë  ê²½ìš° `build/bin` ê²½ë¡œì— í”„ë¡œê·¸ë¨ì´ ìƒì„±ë©ë‹ˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ `spdk_tgt`ëŠ” iSCSi targetê³¼ NVMe-oF target, Vhost ê¸°ëŠ¥ì„ ëª¨ë‘ ì œê³µí•˜ëŠ” ì„œë²„ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. `spdk_tgt`ë¥¼ ì‹¤í–‰í•˜ë©´ SPDK ë“œë¼ì´ë²„ê°€ ë¡œë“œë˜ê³  SPDKì—ì„œ ì œê³µí•˜ëŠ” ëª¨ë“  êµ¬ì„± ìš”ì†Œë¥¼ ì‚¬ìš©í•  ì¤€ë¹„ ìƒíƒœê°€ ë©ë‹ˆë‹¤.

ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±í•˜ê² ì§€ë§Œ, ë³¸ ì˜ˆì œì—ì„œëŠ” ë™ì‘ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ í¬ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤. ë³„ë„ì˜ í„°ë¯¸ë„ì„ ë„ìš°ê³  `build/bin/spdk_tgt`ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. 

  * ìƒˆë¡œìš´ í„°ë¯¸ë„ì—ì„œ ìˆ˜í–‰

  ```
  [root@localhost spdk]# build/bin/spdk_tgt
  [2022-01-13 03:45:42.140847] Starting SPDK v22.01-pre git sha1 ed8be4ad0 / DPDK 21.08.0 initialization...
  [2022-01-13 03:45:42.141026] [ DPDK EAL parameters: [2022-01-13 03:45:42.141060] spdk_tgt [2022-01-13 03:45:42.141086] --no-shconf [2022-01-13 03:45:42.141108] -c 0x1 [2022-01-13 03:45:42.141142] --log-level=lib.eal:6 [2022-01-13 03:45:42.141189] --log-level=lib.cryptodev:5 [2022-01-13 03:45:42.141217] --log-level=user1:6 [2022-01-13 03:45:42.141241] --iova-mode=pa [2022-01-13 03:45:42.141265] --base-virtaddr=0x200000000000 [2022-01-13 03:45:42.141293] --match-allocations [2022-01-13 03:45:42.141316] --file-prefix=spdk_pid9976 [2022-01-13 03:45:42.141339] ]
  EAL: No available 1048576 kB hugepages reported
  EAL: No free 2048 kB hugepages reported on node 1
  TELEMETRY: No legacy callbacks, legacy socket not created
  [2022-01-13 03:45:42.223467] app.c: 543:spdk_app_start: *NOTICE*: Total cores available: 1
  [2022-01-13 03:45:42.354606] reactor.c: 943:reactor_run: *NOTICE*: Reactor started on core 0
  [2022-01-13 03:45:42.354674] accel_engine.c:1012:spdk_accel_engine_initialize: *NOTICE*: Accel engine initialized to use software engine.
  ```

`spdk_tgt`ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©´ RPC í†µì‹ ì„ ìœ„í•œ ì†Œì¼“ íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤. ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì†Œì¼“ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì†Œì¼“ íŒŒì¼ì€ `/var/tmp/spdk.sock` ê²½ë¡œì— ìƒì„±ë©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# ls -l /var/tmp/spdk.sock
  srwxr-xr-x 1 root root 0 Apr  8 19:36 /var/tmp/spdk.sock
  [root@localhost spdk]# lsof -U | grep 'spdk.sock'
  reactor_0  49063           root  373u  unix 0xffff9a31531df2c0      0t0 656974096 /var/tmp/spdk.sock
  [root@localhost spdk]# file /var/tmp/spdk.sock
  /var/tmp/spdk.sock: socket
  ```
ì, SPDK ì‹¤ìŠµì„ ìœ„í•œ í™˜ê²½ êµ¬ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„° SPDKì—ì„œ ì œê³µí•˜ëŠ” bdev ì¤‘ ëª‡ ê°€ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

  * ì°¸ê³ 
    - https://spdk.io/doc/jsonrpc.html
    - https://spdk.io/doc/app_overview.html
    - https://github.com/spdk/spdk/issues/295

&nbsp;

## NVMe ì»¨íŠ¸ë¡¤ëŸ¬ ë“±ë¡

 ì²« ë²ˆì§¸ ì‹¤ìŠµì€ NVMe SSDì˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ë¦¬ëˆ…ìŠ¤ì—ì„œ NVMe SSDë¥¼ ì œì–´í•  ë•Œ `nvme` ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. `nvme` ëª…ë ¹ì€ NVMe githubì˜ nvme-cli ì½”ë“œë¡œ ê´€ë¦¬ë˜ë©° NVMeì˜ ìµœì‹  ìŠ¤í™ì— ë§ì¶°ì„œ ì§€ì†ì ìœ¼ë¡œ ê°œë°œë˜ê³  ìˆìŠµë‹ˆë‹¤.
 
 `nvme` ëª…ë ¹ìœ¼ë¡œ NVMe SSDì˜ ë‹¤ì–‘í•œ ì„¤ì •ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 2019ë…„ë„ ë‹¹ì‹œ, êµ­ì œ ìŠ¤í† ë¦¬ì§€ ì„±ëŠ¥ í‰ê°€ë¥¼ ìˆ˜í–‰í•˜ëŠ” SPC í˜‘íšŒì˜ SPC-1 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ `nvme` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ NVMe SSDì˜ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìˆ˜í–‰í–ˆì—ˆìŠµë‹ˆë‹¤(~~[ë‹¹ì‹œ ì„¸ê³„ ì„±ëŠ¥ 5ìœ„](https://www.etnews.com/20190102000138), ê¹¨ì•Œ ìë‘~~).
 
 ê·¸ë§Œí¼ `nvme` ëª…ë ¹ì€ ê°•ë ¥í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤ë§Œ, SPDKë¡œ ì¥ì¹˜ì˜ ì˜¤ë„ˆì‰½ì„ ë„˜ê¸´ ì´ìƒ `nvme` ëª…ë ¹ìœ¼ë¡œëŠ” ë” ì´ìƒ NVMe SSDë¥¼ ì œì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•œë²ˆ í™•ì¸í•´ ë³¼ê¹Œìš”?

  ```
  [root@localhost spdk]# nvme list
  <no output message>
  ```

`nvme` ëª…ë ¹ì—ì„œ ì œì–´í•  ìˆ˜ ìˆëŠ” ì¥ì¹˜ê°€ ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ NVMe SSD ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ëŠ”ê°€? ì•„ë‹™ë‹ˆë‹¤. NVMe SSD ì œì¡°ì‚¬ëŠ” NVM Express í˜‘íšŒì—ì„œ ì œê³µí•˜ëŠ” í‘œì¤€ ìŠ¤í™ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.

NVMe ìŠ¤í™ì´ ê³µê°œë˜ê¸° ì „ê¹Œì§€ PCIe ê¸°ë°˜ì˜ SSDëŠ” í‘œì¤€ì´ ì—†ì—ˆê¸° ë•Œë¬¸ì— ì œì¡°ì‚¬ë§ˆë‹¤ ìŠ¤í™ì´ ì œê°ê° ì´ì˜€ê³ , ëŒ€ë¶€ë¶„ì˜ ê¸°ìˆ ì´ ê³µê°œë˜ì§€ ì•Šì•„ ì†Œí”„íŠ¸ì›¨ì–´ ê³„ì¸µì—ì„œëŠ” ì ê·¹ì ì¸ í™œìš©ì´ ì–´ë ¤ì› ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œì— ì§ë©´í•˜ì—¬ ì—¬ëŸ¬ ì§„ì˜ì—ì„œ í‘œì¤€í™” ì‘ì—…ì„ ì§„í–‰í•˜ì˜€ê³ , 2013ë…„ ì¸í…”ì´ ì£¼ë„í•œ PCIe SSD í˜‘íšŒì—ì„œ í‘œì¤€ ìŠ¤í™ì¸ NVM Express 1.0e ë²„ì „ì„ ê³µê°œí–ˆìŠµë‹ˆë‹¤.
    
ìŒ... ì ê¹ ìƒ›ê¸¸ë¡œ ë¹ ì¡Œêµ°ìš”. ë‹¤ì‹œ ëŒì•„ì™€ì„œ! NVMe ìŠ¤í™ì„ ì°¸ê³ í•˜ì—¬ SPDKì—ì„œë„ `nvme` ëª…ë ¹ê³¼ ìœ ì‚¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `spdk_tgt`ì„ í¬ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰í•œ ìƒíƒœì—ì„œ ë‹¤ë¥¸ í„°ë¯¸ë„ë¡œ ì ‘ì†í•˜ì—¬ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” NVMe SSDì˜ PCIe ë²ˆí˜¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# lspci | grep -i ssd
  3b:00.0 Non-Volatile memory controller: Intel Corporation Optane SSD 900P Series
  ```

ì•„ ì¢‹ìŠµë‹ˆë‹¤. ì¸í…”ì˜ Optane SSD 900P ì‹œë¦¬ì¦ˆ ì œí’ˆì´ í™•ì¸ë˜ë„¤ìš”. ìª¼ê¸ˆ ìë‘í•˜ë©´ ì—°êµ¬ì†Œì—ëŠ” ì´ëŸ° ì œí’ˆì´ ì‚¬ë¬´ìš© ë§ˆìš°ìŠ¤ë³´ë‹¤ í›¨ì”¬ ë§ìŠµë‹ˆë‹¤(í˜„ì¬ 120ë§Œ ì›, ì¶œì‹œ ë‹¹ì‹œ ê°€ê²© ã…ã„·ã„·).

`3b:00.0`ì„ í™•ì¸í–ˆìœ¼ë‹ˆ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ SPDKì— ì—°ê²°í•´ ë´…ë‹ˆë‹¤. ì´ë•Œ, RPC í†µì‹ ì„ ìœ„í•´ì„œ ëª¨ë“  ëª…ë ¹ì€ `scripts/rpc.py`ë¡œ ìˆ˜í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì‹¤í–‰í•  ëª…ë ¹ì€ `bdev_nvme_attach_controller`ì…ë‹ˆë‹¤. ì—°ê²°í•  ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì´ë¦„ì€ `NVMe0`, ì—°ê²° ë°©ì‹ì€ `pcie`ë¡œ í•˜ê² ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_attach_controller -b NVMe0 -t pcie -a 0000:3b:00.0
  NVMe0n1
  ```

ì˜¤ ë­”ê°€ ëª…ë ¹ì´ ì˜ ìˆ˜í–‰ëœ ëŠë‚Œì…ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ `bdev_nvme_get_controllers` ëª…ë ¹ì„ ìˆ˜í–‰í•˜ì—¬ ì—°ê²°ëœ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê² ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_get_controllers
  [
    {
      "name": "NVMe0",
      "trid": {
        "trtype": "PCIe",
        "traddr": "0000:3b:00.0"
      },
      "host": {
        "nqn": "nqn.2014-08.org.nvmexpress:uuid:2b4d86b5-b34a-4983-9830-2978727acb4a",
        "addr": "",
        "svcid": ""
      }
    }
  ]
  ```

ğŸ‘ğŸ‘ğŸ‘ ì—°ê²°ëœ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ì—°ê²°ì„ í•´ì œí•˜ê³  ì‹¶ìœ¼ë©´ `bdev_nvme_detach_controller` ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_detach_controller NVMe0
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_get_controllers
  []
  ```

ì´ì™¸ì—ë„ SPDKëŠ” nvmeì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# # scripts/rpc.py | grep nvme
      bdev_nvme_set_options (set_bdev_nvme_options)
                            Set options for the bdev nvme type. This is startup
      bdev_nvme_set_hotplug (set_bdev_nvme_hotplug)
                            Set hotplug options for bdev nvme type.
      bdev_nvme_attach_controller (construct_nvme_bdev)
                            Add bdevs with nvme backend
      bdev_nvme_get_controllers (get_nvme_controllers)
      bdev_nvme_detach_controller (delete_nvme_controller)
      bdev_nvme_reset_controller
      bdev_nvme_cuse_register
      bdev_nvme_cuse_unregister
      bdev_nvme_apply_firmware (apply_firmware)
      bdev_nvme_get_transport_statistics
                            Get bdev_nvme poll group transport statistics
      bdev_nvme_get_controller_health_info
      bdev_nvme_opal_init
      bdev_nvme_opal_revert
      bdev_nvme_send_cmd (send_nvme_cmd)
  ```

NVMe SSD ìµœì í™”ë¥¼ ìœ„í•´ ì œì¡°ì‚¬ì—ì„œ ì œê³µí•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì •ì„ ë³€ê²½í•˜ê³  ì‹¶ë‹¤!? ~~í˜ë“¤ì§€ë§Œ~~ ë°©ë²•ì€ ìˆìŠµë‹ˆë‹¤.

ë¨¼ì € PCIe configuration register format(ì•„ë˜ ê·¸ë¦¼ 2)ì„ ë³´ì‹œê³ , BAR(Base Address Registers)ì— ë“±ë¡ëœ NVMe controller register format(ì•„ë˜ ê·¸ë¦¼ 3)ì„ í™•ì¸í•œ ë‹¤ìŒì—, ì–»ìœ¼ë ¤ëŠ” ì •ë³´ê°€ ë§¤í•‘ëœ ë©”ëª¨ë¦¬ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì„œ `bdev_nvme_send_cmd` ëª…ë ¹ì„ ì‚¬ìš©í•´ì„œ NVMe ì»¨íŠ¸ë¡¤ëŸ¬ì— ëª…ë ¹ì„ ë³´ë‚´ë©´ ì•Œë ¤ì¤ë‹ˆë‹¤.

![Alt text](/assets/pci_header.png)
<center>ê·¸ë¦¼ 2. PCIe configuration register format</center>

&nbsp;

![Alt text](/assets/nvme_register.png)
<center>ê·¸ë¦¼ 3. NVMe controller register format</center> (â€» ì¶œì²˜ : [NVMe Spec. version 1.4b document](https://nvmexpress.org/wp-content/uploads/NVM-Express-1_4b-2020.09.21-Ratified.pdf))

&nbsp;

ì ì  ê¹Šì–´ì§€ê³  ì‹¤ìŠµí•˜ê¸° ì‹«ì–´ì§€ë„¤ìš”. í•˜ë“œì›¨ì–´ë¥¼ ì˜ ì•„ëŠ” ê°œë°œìë“¤ì´ NVMe ìŠ¤í™ì„ ì°¸ê³ í•´ì„œ ì¼ë°˜ì¸ë„ í¸íˆ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” `nvme` ëª…ë ¹ì„ ë§Œë“¤ì—ˆëŠ”ë°, ê·¸ê±¸ ì‚¬ìš©í•˜ì§€ ëª»í•˜ë‹ˆê¹Œ ë‹µë‹µí•©ë‹ˆë‹¤.

ë‹¤í–‰íˆë„ SPDKì—ì„œëŠ” `nvme` ëª…ë ¹ì²˜ëŸ¼ ê¸°ì¡´ í”„ë¡œê·¸ë¨ì—ì„œ NVMe SSDì™€ ì§ì ‘ í†µì‹ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ë°”ë¡œ ë¬¸ì ë“œë¼ì´ë²„ ë“±ë¡ì…ë‹ˆë‹¤.

&nbsp;

## ë¬¸ì ë“œë¼ì´ë²„ ë“±ë¡

ìš°ë¦¬ê°€ ì»´í“¨í„°ì— ì¥ì¹˜ë¥¼ ì—°ê²°í•˜ë©´ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì€ ì¥ì¹˜ë¥¼ ì¸ì‹í•´ì„œ ì•Œë§ì€ ë“œë¼ì´ë²„ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë¦¬ëˆ…ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ëŠ” ë¬¸ì, ë¸”ë¡, ë„¤íŠ¸ì›Œí¬ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤. ì´ ì¤‘ì—ì„œ ë¬¸ì ë“œë¼ì´ë²„ëŠ” ì¥ì¹˜ë¥¼ íŒŒì¼ë¡œ ì¶”ìƒí™”í•˜ë©°, ìŠ¤íŠ¸ë¦¼ ë°©ì‹ì˜ ë°ì´í„° ì „ì†¡ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ì‹œìŠ¤í…œ ì½œ[^4] ioctl()ì€ ìŠ¤íŠ¸ë¦¼ ë°©ì‹ìœ¼ë¡œ ì¥ì¹˜ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” ëŒ€í‘œì ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤. `nvme` ëª…ë ¹ë„ ëŒ€ë¶€ë¶„ ioctl()ë¥¼ í†µí•´ ì¥ì¹˜ë¥¼ ì œì–´í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ, SPDKì— ì¥ì¹˜ë¥¼ ë“±ë¡í•˜ë©´ ì»¤ë„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œ ë‹¤ë£° ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ SPDKëŠ” CUSE[^5] ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ê³µê°„ì—ì„œ êµ¬í˜„ëœ SPDK ê¸°ëŠ¥ì„ ë¬¸ì ë“œë¼ì´ë²„ë¡œ ì œê³µí•©ë‹ˆë‹¤.

ì´ì œ ë¬¸ì ë“œë¼ì´ë²„ ë“±ë¡ ì‹¤ìŠµì„ í•´ë³´ê² ìŠµë‹ˆë‹¤. ë¨¼ì € í…ŒìŠ¤íŠ¸ ì„œë²„ì— cuse íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ë™ì‘ ì¤‘ì¸ `spdk_tgt`ë¥¼ Ctrl+Cë¡œ ì¢…ë£Œí•˜ê³ , ./configure ëª…ë ¹ì— `--with-nvme-cuse` ì˜µì…˜ì„ ì¶”ê°€í•˜ê³  ë¦¬ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  ```
  [2022-01-13 03:46:48.864407] bdev_nvme_rpc.c: 400:rpc_bdev_nvme_attach_controller: *ERROR*: The multipath parameter was not specified to bdev_nvme_attach_controller but it was used to add a failover path. This behavior will default to rejecting the request in the future. Specify the 'multipath' parameter to control the behavior[2022-01-13 03:46:33.714712] bdev_nvme.c:3620:bdev_nvme_delete: *ERROR*: Failed to find NVMe bdev controller
  ^C
  [root@localhost spdk]# 
  [root@localhost spdk]# ./configure --with-nvme-cuse
  Notice: ISA-L, compression & crypto require NASM version 2.14 or newer. Turning off default ISA-L and crypto features.
  Using default SPDK env in /root/spdk/lib/env_dpdk
  Using default DPDK in /root/spdk/dpdk/build
  Creating mk/config.mk...done.
  Creating mk/cc.flags.mk...done.
  Type 'make' to build.
  [root@localhost spdk]# make -j 40
  ... <Done>
  ```

ë¦¬ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. `spdk_tgt` í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ê¸° ì „ì— cuse ì»¤ë„ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

  ```
  [root@localhost spdk]# modprobe cuse
  [root@localhost spdk]# lsmod | grep cuse
  cuse                   13274  0
  fuse                  100350  4 cuse
  [root@localhost spdk]# ./build/bin/spdk_tgt
  [2022-01-13 03:47:44.436670] Starting SPDK v22.01-pre git sha1 ed8be4ad0 / DPDK 21.08.0 initialization...
  [2022-01-13 03:47:44.436857] [ DPDK EAL parameters: [2022-01-13 03:47:44.436891] spdk_tgt [2022-01-13 03:47:44.436919] --no-shconf [2022-01-13 03:47:44.436945] -c 0x1 [2022-01-13 03:47:44.436969] --log-level=lib.eal:6 [2022-01-13 03:47:44.436995] --log-level=lib.cryptodev:5 [2022-01-13 03:47:44.437019] --log-level=user1:6 [2022-01-13 03:47:44.437072] --iova-mode=pa [2022-01-13 03:47:44.437098] --base-virtaddr=0x200000000000 [2022-01-13 03:47:44.437121] --match-allocations [2022-01-13 03:47:44.437145] --file-prefix=spdk_pid66198 [2022-01-13 03:47:44.437168] ]
  EAL: No available 1048576 kB hugepages reported
  EAL: No free 2048 kB hugepages reported on node 1
  TELEMETRY: No legacy callbacks, legacy socket not created
  [2022-01-13 03:47:44.519003] app.c: 543:spdk_app_start: *NOTICE*: Total cores available: 1
  [2022-01-13 03:47:44.648331] reactor.c: 943:reactor_run: *NOTICE*: Reactor started on core 0
  [2022-01-13 03:47:44.648394] accel_engine.c:1012:spdk_accel_engine_initialize: *NOTICE*: Accel engine initialized to use software engine.
  ```

ë¦¬ë¹Œë“œ ë° `spdk_tgt`ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆë‹¤ë©´ ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ë¬¸ì ë“œë¼ì´ë²„ë¥¼ ë“±ë¡í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë¬¸ì ë“œë¼ì´ë²„ ë“±ë¡ì€ `bdev_nvme_cuse_register` ëª…ë ¹ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_attach_controller -b NVMe0 -t PCIe -a 0000:3b:00.0
  NVMe0n1
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_cuse_register -n NVMe0
  ```

`spdk_tgt` í„°ë¯¸ë„ì—ì„œ ë¬¸ì ë“œë¼ì´ë²„ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆë‹¤ëŠ” ë¡œê·¸ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.

  ```
  [2022-01-13 03:47:52.183893] nvme_cuse.c: 972:nvme_cuse_start: *NOTICE*: Creating cuse device for controller
  [2022-01-13 03:47:52.184053] nvme_cuse.c: 763:cuse_session_create: *NOTICE*: fuse session for device spdk/nvme0 created
  [2022-01-13 03:47:52.184117] nvme_cuse.c: 763:cuse_session_create: *NOTICE*: fuse session for device spdk/nvme0n1 created
  ```

ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ë¬¸ì ë“œë¼ì´ë²„ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤. `/dev/spdk` ë””ë ‰í† ë¦¬ í•˜ìœ„ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# ls /dev/spdk/
  nvme0  nvme0n1
  ```

ì´ì œ `nvme` ëª…ë ¹ì„ ì‚¬ìš©í•´ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ í™•ì¸í•´ ë´…ì‹œë‹¤. `nvme` ëª…ë ¹ì— `-H` ì˜µì…˜(--human-readable)ì„ ì¶”ê°€í•˜ë©´ [ê·¸ë¦¼ 3]ì—ì„œ ë³´ì—¬ì¤€ NVMe controller register format ì •ë³´ë¥¼ ë³´ê¸° ì‰½ê²Œ ë³€í™˜í•´ ì¤ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# nvme id-ctrl /dev/spdk/nvme0 -H
  NVME Identify Controller:
  vid       : 0x8086
  ssvid     : 0x8086
  sn        : PHMB7435004J280CGN
  mn        : INTEL SSDPED1D280GA
  fr        : E2010325
  rab       : 0
  ieee      : 5cd2e4
  cmic      : 0
  [2:2] : 0     PCI
  [1:1] : 0     Single Controller
  [0:0] : 0     Single Port
  ...
  [root@localhost spdk]# scripts/rpc.py bdev_get_bdevs
  [
    {
    "name": "NVMe0n1",
      "aliases": [],
      "product_name": "NVMe disk",
      "block_size": 512,
      "num_blocks": 547002288,
      "uuid": "0b1f1ff5-4bb6-4fea-b436-0359ad12f7ee",
      "assigned_rate_limits": {
        "rw_ios_per_sec": 0,
        "rw_mbytes_per_sec": 0,
        "r_mbytes_per_sec": 0,
        "w_mbytes_per_sec": 0
      },
      "claimed": true,
      "zoned": false,
      "supported_io_types": {
        "read": true,
        "write": true,
        "unmap": true,
        "write_zeroes": true,
        "flush": true,
        "reset": true,
        "nvme_admin": true,
        "nvme_io": true
      },
      "driver_specific": {
        "nvme": {
          "pci_address": "0000:3b:00.0",
          "trid": {
            "trtype": "PCIe",
            "traddr": "0000:3b:00.0"
          },
          "cuse_device": "spdk/nvme0n1",
          "ctrlr_data": {
            "vendor_id": "0x8086",
            "model_number": "INTEL SSDPED1D280GA",
            "serial_number": "PHMB7435004J280CGN",
            "firmware_revision": "E2010325",
            "oacs": {
              "security": 1,
              "format": 1,
              "firmware": 1,
              "ns_manage": 0
            }
          },
          "vs": {
            "nvme_version": "1.0"
          },
          "ns_data": {
            "id": 1
          },
          "security": {
            "opal": false
          }
        }
      }
    }
  ]
  ```

`nvme id-ctrl`ë¡œ í™•ì¸í•œ NVMe SSD ì •ë³´ì™€ SPDKì˜ `bdev_get_bdevs` ì¶œë ¥ ê²°ê³¼ê°€ ë™ì¼í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë§ˆì§€ë§‰ìœ¼ë¡œ ë¬¸ì ë“œë¼ì´ë²„ ë“±ë¡ì„ í•´ì œí•˜ë ¤ë©´ `bdev_nvme_cuse_unregister` ëª…ë ¹ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_nvme_cuse_unregister -n NVMe0
  [root@localhost spdk]# ls /dev/spdk/nvme0
  ls: cannot access /dev/spdk/nvme0: No such file or directory
  ```

  * ì°¸ê³ 
    - https://spdk.io/doc/nvme.html

&nbsp;

## lvol ìƒì„±

ë‹¤ìŒìœ¼ë¡œ ë…¼ë¦¬ ë³¼ë¥¨ì„ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤. SPDKì—ì„œëŠ” lvol ëª¨ë“ˆì„ í†µí•´ ë…¼ë¦¬ ë³¼ë¥¨ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. lvolì€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ì œê³µí•˜ëŠ” LVM(Logical Volume Manager)[^6]ì˜ LV(Logical Volume)ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

lvol ìƒì„±ì€ NVMe SSDë¥¼ 'ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œ'ì— ë“±ë¡í•˜ëŠ” ì‘ì—…ì´ ì„ í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” LVMì—ì„œ PV(Phisical Volume)ë¥¼ VG(Volume Group)ì— ë“±ë¡í•˜ëŠ” ì‘ì—…ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†ŒëŠ” lvstoreë¡œ ë¶ˆë¦½ë‹ˆë‹¤. lvstore ìƒì„±ì€ `bdev_lvol_create_lvstore` ëª…ë ¹ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `bdev_lvol_create_lvstore`ì˜ ì²« ë²ˆì§¸ ì¸ìëŠ” `bdev_get_bdevs` ëª…ë ¹ìœ¼ë¡œ ì¶œë ¥ëœ ì¥ì¹˜ì˜ ì´ë¦„ì´ ì…ë ¥ë˜ë©°, ë‘ ë²ˆì§¸ ì¸ìëŠ” ë“±ë¡í•  ì‹ ê·œ ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œì˜ ì´ë¦„ì…ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_create_lvstore NVMe0n1 lvs
  1818d45a-3a05-42c9-bbb2-9229cc25ac49
  ```

NVMe SSDê°€ ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œì— ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ë©´ ìƒì„±ëœ lvstoreì˜ uuidë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†ŒëŠ” `bdev_lvol_get_lvstores` ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ, `bdev_get_bdevs` ëª…ë ¹ìœ¼ë¡œëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_get_lvstores
  [
    {
      "uuid": "1818d45a-3a05-42c9-bbb2-9229cc25ac49",
        "name": "lvs",
        "base_bdev": "NVMe0n1",
        "total_data_clusters": 66706,
        "free_clusters": 66706,
        "block_size": 512,
        "cluster_size": 4194304
    }
  ]
  ```

ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œ ì‚­ì œëŠ” `bdev_lvol_delete_lvstore` ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_delete_lvstore -l lvs
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_get_lvstores
  []
  ```

ë‹¤ìŒìœ¼ë¡œ ë…¼ë¦¬ ë³¼ë¥¨ì„ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë…¼ë¦¬ ë³¼ë¥¨ì€ `bdev_lvol_create` ëª…ë ¹ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `bdev_lvol_create`ì˜ ì²« ë²ˆì§¸ ì¸ìëŠ” ìƒì„±í•  ë…¼ë¦¬ ë³¼ë¥¨ì˜ ì´ë¦„ì´ë©°, ë‘ ë²ˆì§¸ ì¸ìëŠ” ë…¼ë¦¬ ë³¼ë¥¨ì˜ í¬ê¸°ë¡œ ê¸°ë³¸ ë‹¨ìœ„ëŠ” MiBì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ `-l` ì˜µì…˜ìœ¼ë¡œ ìƒì„±ëœ ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œì˜ ì´ë¦„ ë˜ëŠ” uuidë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆì œë¡œ lvs ì´ë¦„ì˜ ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œì— 1GB ìš©ëŸ‰ì„ ê°–ëŠ” lvol1 ë…¼ë¦¬ ë³¼ë¥¨ì„ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_create lvol1 1024 -l lvs
  68ba7bbc-d26b-464b-ae12-f48a62512b0d
  ```

ë…¼ë¦¬ ë³¼ë¥¨ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ë©´ ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ lvolì˜ uuidë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. SPDKì—ì„œ ìƒì„±ëœ ë…¼ë¦¬ ë³¼ë¥¨ì€ `bdev_get_bdevs` ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ, `bdev_get_lvstores`ì™€ ê°™ì´ ë…¼ë¦¬ ë³¼ë¥¨ ì •ë³´ë§Œ ì¶œë ¥í•˜ëŠ” ëª…ë ¹ì€ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_get_bdevs
  [
    {...},
    {
        "name": "68ba7bbc-d26b-464b-ae12-f48a62512b0d",
        "aliases": [
            "lvs/lvol1"
        ],
        "product_name": "Logical Volume",
        "block_size": 512,
        "num_blocks": 2097152,
        "uuid": "68ba7bbc-d26b-464b-ae12-f48a62512b0d",
        "assigned_rate_limits": {
            "rw_ios_per_sec": 0,
            "rw_mbytes_per_sec": 0,
            "r_mbytes_per_sec": 0,
            "w_mbytes_per_sec": 0
        },
        "claimed": false,
        "zoned": false,
        "supported_io_types": {
            "read": true,
            "write": true,
            "unmap": true,
            "write_zeroes": true,
            "flush": false,
            "reset": true,
            "nvme_admin": false,
            "nvme_io": false
        },
        "driver_specific": {
            "lvol": {
                "lvol_store_uuid": "6579330a-4748-472c-a249-adce070ec15e",
                "base_bdev": "NVMe0n1",
                "thin_provision": false,
                "snapshot": false,
                "clone": false
            }
        }
    }
  ]
  ```

`bdev_get_bdevs` ìˆ˜í–‰ ê²°ê³¼, ë…¼ë¦¬ ë³¼ë¥¨ ì €ì¥ì†Œ lvsì—ì„œ 1GB ìš©ëŸ‰ì„ ê°–ëŠ” ë…¼ë¦¬ ë³¼ë¥¨ lovl1ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ ë³¼ë¥¨ì˜ ìš©ëŸ‰ì€ `block_size`ì™€ `num_blocks` ê°’ìœ¼ë¡œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ ì˜ˆì‹œì—ì„œëŠ” 512 byte í¬ê¸°ë¥¼ ê°–ëŠ” ë¸”ë¡ì´ 2,097,152ê°œ ìƒì„±ë˜ì–´ ì „ì²´ 1,073,741,824 byte(=1GB) ìš©ëŸ‰ì´ í• ë‹¹ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìƒì„±ëœ ë…¼ë¦¬ ë³¼ë¥¨ ì‚­ì œëŠ” `bdev_lvol_delete` ëª…ë ¹ì„ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_lvol_delete lvs/lvol1
  ```

ì´ì™¸ì—ë„ ë…¼ë¦¬ ë³¼ë¥¨ì€ ìŠ¤ëƒ…ìƒ·, í´ë¡ , í¬ê¸° ë³€ê²½ ë“±, ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ ì œê³µí•©ë‹ˆë‹¤. ì¶”ê°€ ê¸°ëŠ¥ì— ëŒ€í•œ ì„¤ëª…ì€ [logical volumes document](https://spdk.io/doc/logical_volumes.html)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  * ì°¸ê³ 
    - https://spdk.io/doc/bdev.html
    - https://spdk.io/doc/logical_volumes.html

&nbsp;

## RAID ìƒì„±

SPDKëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ê¸°ë°˜ì˜ RAID[^7] ë³¼ë¥¨ì„ ì§€ì›í•©ë‹ˆë‹¤. ë‹¤ë§Œ í˜„ì¬ê¹Œì§€ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì€ ë ˆë²¨ 0 ë¿ì…ë‹ˆë‹¤. RAID-0ì€ RAID ë³¼ë¥¨ì— ì°¸ì—¬ëœ ì¥ì¹˜ë“¤ì— ë¶„ì‚°ë˜ëŠ” êµ¬ì¡°ë¡œ ì„±ëŠ¥ì€ ë›°ì–´ë‚˜ì§€ë§Œ í•˜ë‚˜ì˜ ì¥ì¹˜ì— ì´ìƒì´ ìƒê¸¸ ê²½ìš° ë°ì´í„°ì˜ ë¬´ê²°ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëŒ€ë¶€ë¶„ì˜ ì†Œí”„íŠ¸ì›¨ì–´ RAIDëŠ” RAID ë³¼ë¥¨ ì •ë³´(metdata)ë¥¼ ë³¼ë¥¨ì— í¬í•¨ëœ ì¥ì¹˜ì˜ íŠ¹ì • ì˜ì—­ì— ì§ì ‘ ê¸°ë¡í•˜ì§€ë§Œ, SPDKì˜ RAIDëŠ” í˜„ì¬ê¹Œì§€ ì €ì¥ë§¤ì²´ì— RAID ë³¼ë¥¨ ì •ë³´ë¥¼ ê¸°ë¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ê²½ìš° SPDK í”„ë ˆì„ì›Œí¬ë¥¼ ì¬ì‹œì‘í•˜ë©´ ê¸°ì¡´ì— êµ¬ì„±í–ˆì—ˆë˜ RAID ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. (â€»RAIDì™€ ë°˜ëŒ€ë¡œ ë…¼ë¦¬ ë³¼ë¥¨ì€ ì¬ì‹œì‘ì„ í•˜ë”ë¼ë„ êµ¬ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.)

RAID ë³¼ë¥¨ ìƒì„±ì€ `bdev_raid_create` ëª…ë ¹ì„ í†µí•´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ ìƒì„±í•  RAID ì´ë¦„(`-n`)ê³¼ ìŠ¤íŠ¸ë¼ì´í”„ í¬ê¸°(`-z`), RAID ë²ˆí˜¸(`-r`), ë“±ë¡í•  ì¥ì¹˜(`-b`)ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆì œë¡œ 4ê°œì˜ lvolë¥¼ ë¬¶ì–´ì„œ ë ˆë²¨ 0 RAID ë³¼ë¥¨ì„ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_raid_create -n raid0 -z 64 -r 0 -b "lvol1 lvol2 lvol3 lvol4"
  ```

ì•„ë¬´ëŸ° ê²°ê³¼ê°€ ì¶œë ¥ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤(?).

RAID ì¥ì¹˜ ì •ë³´ëŠ” `bdev_raid_get_bdevs` ëª…ë ¹ì„ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°, ì´ë•Œ ì¸ì ê°’ìœ¼ë¡œ RAIDì˜ ìƒíƒœ ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ëŠ” `all`, `online`, `configuring`, `offline`ì´ ìˆìŠµë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_raid_get_bdevs all
  raid0
  ```

ì•„ì‰½ê²Œë„ RAIDì— ëŒ€í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ëª…ë ¹ì€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ êµ¬í˜„ëœ RAID ê´€ë ¨ëœ ê¸°ëŠ¥ì€ ìƒì„±, ë¦¬ìŠ¤íŠ¸ ì¶œë ¥, ì‚­ì œ ê¸°ëŠ¥ë¿ì…ë‹ˆë‹¤. `bdev_get_bdevs` ê²°ê³¼ì—ì„œë„ êµ¬ì„±í•œ RAID ì •ë³´ëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ì‚­ì œëŠ” `bdev_raid_delete` ëª…ë ¹ì„ í†µí•´ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_raid_delete raid0
  ```

RAID ìƒì„±ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì •ìƒì ìœ¼ë¡œ ì‚­ì œëœ ê²½ìš° ì•„ë¬´ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤(???).

RAID bdev ëª¨ë“ˆì€ ì•„ì§ê¹Œì§€ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í˜„ì¬ê¹Œì§€ êµ¬í˜„ëœ ê¸°ëŠ¥ë§Œìœ¼ë¡œëŠ” ë†’ì€ ì„±ëŠ¥ì´ ìš”êµ¬ë˜ì§€ë§Œ ì•ˆì •ì„±ì€ ë‚®ì•„ë„ ê´œì°®ì€ ì¼íšŒì„± ì €ì¥ ëª©ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤.

ë‹¤ë§Œ RAIDì— ëŒ€í•œ ì¶”ê°€ ê¸°ëŠ¥ ì œê³µì´ ì „í˜€ ì—†ëŠ” ê²ƒì€ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì»¤ë®¤ë‹ˆí‹°ì—ì„œëŠ” RAID-5 êµ¬í˜„ì— ëŒ€í•œ í•„ìš”ì„±ì´ ì–¸ê¸‰ë˜ì—ˆìœ¼ë©°([ë§í¬](https://lists.01.org/hyperkitty/list/spdk@lists.01.org/thread/DBSZDNBGNWV6PD7MOF7V5M7EOQP4EVTJ/)), RAID-1ì˜ ê²½ìš° ì¼ë¶€ ì½”ë“œê°€ [yupeng0921 github](https://github.com/yupeng0921/spdk/tree/raid1/module/bdev/raid1)ì— ê³µê°œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë˜í•œ SPDK githubì—ëŠ” [RAID-5 ì½”ë“œ](https://github.com/spdk/spdk/blob/master/module/bdev/raid/raid5.c)ë¥¼ ì¼ë¶€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„í•˜, ê·¸ë ‡ë‹¤ë©´ ê°€ê¹Œìš´ ë¯¸ë˜ì— ì•ˆì •ì ìœ¼ë¡œ ë ˆë²¨ 5 RAID ë³¼ë¥¨ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ìƒê°í•˜ê³  í˜„ì¬ ë²„ì „ì—ì„œ RAID-5 ë³¼ë¥¨ì„ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € `./configure`ì—ì„œ `--with-raid5` ì˜µì…˜ì„ ì¶”ê°€í•˜ê³  ë¦¬ë¹Œë“œë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤. 

  ```
  [root@localhost spdk]# ./configure --with-raid5
  [root@localhost spdk]# make -j 40
  [root@localhost spdk]# ./build/bin/spdk_tgt
  ```

ë¦¬ë¹Œë“œ ë° `spdk_tgt` ì‹œì‘ì„ ì™„ë£Œí•˜ê³  `bdev_raid_create` ëª…ë ¹ì—ì„œ RAID ë ˆë²¨(`-r`)ì„ 5ë¡œ ì…ë ¥í•˜ë©´ RAID-5 ë³¼ë¥¨ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ RAID-0ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì¬ì‹œì‘ ì‹œ êµ¬ì„±í–ˆë˜ ë³¼ë¥¨ ì •ë³´ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤.

  ```
  [root@localhost spdk]# scripts/rpc.py bdev_raid_create -n raid5 -z 64 -r 5 -b "lvol1 lvol2 lvol3 lvol4"
  [root@localhost spdk]# scripts/rpc.py bdev_raid_get_bdevs all
  raid5
  ```

  * ì°¸ê³ 
    - https://lists.01.org/hyperkitty/list/spdk@lists.01.org/thread/DBSZDNBGNWV6PD7MOF7V5M7EOQP4EVTJ/
    - https://github.com/yupeng0921/spdk/tree/raid1/module/bdev/raid1
    - https://github.com/spdk/spdk/blob/master/module/bdev/raid/raid5.c

&nbsp;

ë§ˆì¹˜ë©°
-----

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” NVMe SSDê°€ ì„¤ì¹˜ëœ ì‹¤ì¥ë¹„ì— SPDK ìµœì‹  ì½”ë“œë¥¼ ì˜¬ë ¤ë³´ê³  bdev ëª¨ë“ˆì—ì„œ ì œê³µí•˜ëŠ” ì¼ë¶€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ë³´ì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‹œê°„ì—ëŠ” SPDK ì„±ëŠ¥ ë¦¬í¬íŠ¸ë¥¼ ë¶„ì„í•˜ê³  SPDK í™˜ê²½ì—ì„œ ì„±ëŠ¥ì„ ì¸¡ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ê·¸ëŸ¼ ë‹¤ìŒì— ë§Œë‚˜ìš”ğŸ‘‹

&nbsp;

ê°ì£¼
---

[^1]: VFIO : [Virtual Function I/O](https://www.kernel.org/doc/Documentation/vfio.txt)
[^2]: UIO : [Userspace I/O](https://www.kernel.org/doc/html/v4.12/driver-api/uio-howto.html)
[^3]: JSON-RPC : https://www.jsonrpc.org/specification
[^4]: System-call : https://en.wikipedia.org/wiki/System_call
[^5]: CUSE : [Character device in Userspace](https://lwn.net/Articles/308445/)
[^6]: LVM : [Logical Volume Manager](https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux))
[^7]: RAID : [Redundant Array of Inexpensive Disks](https://en.wikipedia.org/wiki/RAID)
